import React, { useMemo, useState } from "react";

/**
 * Mobile Chase-style Payment Portal (Demo)
 * - TailwindCSS utility classes
 * - No external UI libs required
 * - Random transactions generated on mount
 * - Single-file React component ready for preview
 */

// Simple utility to format USD
const usd = (n) => n.toLocaleString("en-US", { style: "currency", currency: "USD" });

// Deterministic pseudo-random for stable previews
function mulberry32(a) {
  return function () {
    let t = (a += 0x6d2b79f5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}

const merchantPool = [
  { name: "AMZN Mktp US*8F2K", cat: "Shopping" },
  { name: "Uber *Trip 9A12", cat: "Transport" },
  { name: "Lyft *Ride 42", cat: "Transport" },
  { name: "Apple.com/bill", cat: "Digital" },
  { name: "Trader Joe's #482", cat: "Groceries" },
  { name: "Whole Foods 1042", cat: "Groceries" },
  { name: "Starbucks Store 1180", cat: "Cafe" },
  { name: "Delta Air 006", cat: "Travel" },
  { name: "Shell Oil 2243119", cat: "Gas" },
  { name: "CVS Pharmacy 9321", cat: "Pharmacy" },
  { name: "DOORDASH *Order 7C", cat: "Food Delivery" },
  { name: "Airbnb *Miami", cat: "Travel" },
  { name: "Best Buy #102", cat: "Electronics" },
  { name: "Spotify USA", cat: "Subscription" },
  { name: "Netflix.com", cat: "Subscription" },
  { name: "Costco Whse #449", cat: "Warehouse" },
];

const catIcon = (cat) => {
  const base = "w-10 h-10 flex items-center justify-center rounded-xl text-xs font-semibold";
  switch (cat) {
    case "Shopping":
      return <div className={`${base} bg-indigo-100`}>🛍️</div>;
    case "Transport":
      return <div className={`${base} bg-emerald-100`}>🚗</div>;
    case "Digital":
      return <div className={`${base} bg-cyan-100`}>💾</div>;
    case "Groceries":
      return <div className={`${base} bg-green-100`}>🥑</div>;
    case "Cafe":
      return <div className={`${base} bg-amber-100`}>☕</div>;
    case "Travel":
      return <div className={`${base} bg-sky-100`}>✈️</div>;
    case "Gas":
      return <div className={`${base} bg-orange-100`}>⛽</div>;
    case "Pharmacy":
      return <div className={`${base} bg-rose-100`}>💊</div>;
    case "Food Delivery":
      return <div className={`${base} bg-pink-100`}>🍔</div>;
    case "Electronics":
      return <div className={`${base} bg-purple-100`}>🔌</div>;
    case "Subscription":
      return <div className={`${base} bg-blue-100`}>♻️</div>;
    case "Warehouse":
      return <div className={`${base} bg-lime-100`}>📦</div>;
    default:
      return <div className={`${base} bg-slate-100`}>🧾</div>;
  }
};

// Generate a few days of transactions
function useRandomTransactions(seed = 7, days = 5, perDay = [3, 6]) {
  const rng = useMemo(() => mulberry32(seed), [seed]);
  return useMemo(() => {
    const out = [];
    for (let d = 0; d < days; d++) {
      const dayCount = Math.floor(rng() * (perDay[1] - perDay[0] + 1)) + perDay[0];
      const date = new Date();
      date.setDate(date.getDate() - d);
      for (let i = 0; i < dayCount; i++) {
        const m = merchantPool[Math.floor(rng() * merchantPool.length)];
        const amt = Math.round((rng() * 240 + 6) * 100) / 100; // $6 - $246
        out.push({
          id: `${d}-${i}`,
          date: new Date(date),
          merchant: m.name,
          category: m.cat,
          amount: amt,
        });
      }
    }
    // Sort by date desc
    out.sort((a, b) => b.date.getTime() - a.date.getTime());
    return out;
  }, [rng]);
}

function SectionTitle({ children }) {
  return <div className="text-slate-900 text-sm font-semibold mb-2">{children}</div>;
}

function Segmented({ value, onChange, options }) {
  return (
    <div className="flex gap-2 bg-slate-100 p-1 rounded-2xl">
      {options.map((opt) => (
        <button
          key={opt.value}
          onClick={() => onChange(opt.value)}
          className={`px-3 py-1.5 rounded-xl text-sm transition shadow-sm ${
            value === opt.value ? "bg-white text-slate-900" : "text-slate-600 hover:text-slate-900"
          }`}
        >
          {opt.label}
        </button>
      ))}
    </div>
  );
}

function AmountPill({ label, sub, selected, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`flex-1 min-w-[32%] rounded-2xl p-3 border text-left transition ${
        selected ? "border-blue-500 bg-blue-50" : "border-slate-200 hover:border-slate-300"
      }`}
    >
      <div className="text-xs text-slate-500">{label}</div>
      <div className="text-sm font-semibold text-slate-900">{sub}</div>
    </button>
  );
}

function Progress({ value }) {
  return (
    <div className="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
      <div
        className="h-full bg-blue-600"
        style={{ width: `${Math.min(100, Math.max(0, value))}%` }}
      />
    </div>
  );
}

export default function App() {
  const TOTAL_DEBT = 40000;
  const MIN_DUE = 820; // demo
  const STATEMENT_BALANCE = 12400; // demo
  const AVAILABLE_CASH = 13842.12; // demo "Pay from"

  const txns = useRandomTransactions(23, 5);

  const [tab, setTab] = useState("pay");
  const [amountMode, setAmountMode] = useState("preset");
  const [selectedPreset, setSelectedPreset] = useState("min");
  const [customAmount, setCustomAmount] = useState(usd(MIN_DUE));
  const [schedule, setSchedule] = useState("today");
  const [note, setNote] = useState("");

  const computedAmount = (() => {
    if (amountMode === "custom") {
      // Parse from currency string
      const raw = parseFloat(String(customAmount).replace(/[^0-9.]/g, ""));
      return isNaN(raw) ? 0 : Math.min(raw, TOTAL_DEBT);
    }
    if (selectedPreset === "min") return MIN_DUE;
    if (selectedPreset === "statement") return STATEMENT_BALANCE;
    return TOTAL_DEBT;
  })();

  const progress = (computedAmount / TOTAL_DEBT) * 100;

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
      {/* Safe area wrapper for mobile */}
      <div className="mx-auto max-w-sm">{/* Mobile width */}
        {/* Header */}
        <header className="sticky top-0 z-20 backdrop-blur bg-white/75 border-b border-slate-200">
          <div className="px-4 py-3 flex items-center gap-3">
            <div className="w-8 h-8 rounded-md bg-blue-700 grid place-items-center text-white font-black tracking-tight">
              {/* Generic bank logo */}
              <span className="text-[10px] leading-none">BK</span>
            </div>
            <div className="flex-1">
              <div className="text-[10px] uppercase tracking-wider text-slate-500">Chase</div>
              <div className="text-sm font-semibold">Credit Card</div>
            </div>
            <button
              className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200"
              onClick={() => alert("This is a demo mock.")}
            >
              Help
            </button>
          </div>
        </header>

        {/* Balance Card */}
        <main className="px-4 pb-28">
          <div className="mt-4 rounded-3xl p-4 bg-gradient-to-br from-blue-700 via-blue-600 to-blue-800 text-white shadow-lg">
            <div className="text-xs/4 opacity-90">Total Balance</div>
            <div className="text-3xl font-semibold mt-1">{usd(TOTAL_DEBT)}</div>
            <div className="mt-3 flex items-center gap-2">
              <Progress value={(STATEMENT_BALANCE / TOTAL_DEBT) * 100} />
            </div>
            <div className="mt-2 text-[11px] opacity-90 flex items-center justify-between">
              <span>Statement Balance: {usd(STATEMENT_BALANCE)}</span>
              <span>Min Due: {usd(MIN_DUE)}</span>
            </div>
          </div>

          {/* Tabs */}
          <div className="mt-5">
            <Segmented
              value={tab}
              onChange={setTab}
              options=[
                { label: "Pay", value: "pay" },
                { label: "Activity", value: "activity" },
                { label: "Account", value: "account" },
              ]
            />
          </div>

          {tab === "pay" && (
            <section className="mt-5 space-y-6">
              {/* Amount */}
              <div>
                <SectionTitle>Choose amount</SectionTitle>
                <div className="flex gap-3">
                  <AmountPill
                    label="Minimum due"
                    sub={usd(MIN_DUE)}
                    selected={amountMode === "preset" && selectedPreset === "min"}
                    onClick={() => {
                      setAmountMode("preset");
                      setSelectedPreset("min");
                    }}
                  />
                  <AmountPill
                    label="Statement"
                    sub={usd(STATEMENT_BALANCE)}
                    selected={amountMode === "preset" && selectedPreset === "statement"}
                    onClick={() => {
                      setAmountMode("preset");
                      setSelectedPreset("statement");
                    }}
                  />
                  <AmountPill
                    label="Pay in full"
                    sub={usd(TOTAL_DEBT)}
                    selected={amountMode === "preset" && selectedPreset === "full"}
                    onClick={() => {
                      setAmountMode("preset");
                      setSelectedPreset("full");
                    }}
                  />
                </div>

                <div className="mt-3 flex items-center gap-2">
                  <input
                    inputMode="decimal"
                    aria-label="Custom amount"
                    className={`w-full rounded-2xl border px-4 py-3 text-lg font-semibold tracking-wide ${
                      amountMode === "custom"
                        ? "border-blue-500 bg-blue-50 text-blue-900"
                        : "border-slate-200 bg-white"
                    }`}
                    value={customAmount}
                    onFocus={() => setAmountMode("custom")}
                    onChange={(e) => setCustomAmount(e.target.value)}
                  />
                  <button
                    className="shrink-0 rounded-2xl px-3 py-3 border border-slate-200 text-sm hover:bg-slate-50"
                    onClick={() => {
                      setAmountMode("preset");
                      setSelectedPreset("min");
                      setCustomAmount(usd(MIN_DUE));
                    }}
                    title="Reset to minimum due"
                  >
                    Reset
                  </button>
                </div>
                <div className="mt-1 text-[11px] text-slate-500">Up to your total balance.</div>
              </div>

              {/* Pay From */}
              <div>
                <SectionTitle>Pay from</SectionTitle>
                <div className="flex items-center justify-between rounded-2xl border border-slate-200 p-3">
                  <div>
                    <div className="text-sm font-semibold">Chase Checking •••• 8241</div>
                    <div className="text-xs text-slate-500">Available: {usd(AVAILABLE_CASH)}</div>
                  </div>
                  <button className="text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Change</button>
                </div>
              </div>

              {/* Schedule */}
              <div>
                <SectionTitle>Schedule</SectionTitle>
                <div className="grid grid-cols-3 gap-2">
                  {[
                    { k: "today", label: "Today" },
                    { k: "tomorrow", label: "Tomorrow" },
                    { k: "pick", label: "Pick date" },
                  ].map((o) => (
                    <button
                      key={o.k}
                      onClick={() => setSchedule(o.k)}
                      className={`rounded-2xl border px-3 py-2 text-sm ${
                        schedule === o.k ? "border-blue-500 bg-blue-50" : "border-slate-200"
                      }`}
                    >
                      {o.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Note (optional) */}
              <div>
                <SectionTitle>Memo (optional)</SectionTitle>
                <input
                  className="w-full rounded-2xl border border-slate-200 px-3 py-2 text-sm"
                  placeholder="Add a note for your records"
                  value={note}
                  onChange={(e) => setNote(e.target.value)}
                />
              </div>

              {/* Summary */}
              <div className="rounded-2xl border border-slate-200 p-3 text-sm">
                <div className="flex items-center justify-between py-1">
                  <span>Payment amount</span>
                  <span className="font-semibold">{usd(computedAmount)}</span>
                </div>
                <div className="flex items-center justify-between py-1 text-slate-600">
                  <span>Remaining balance</span>
                  <span>{usd(Math.max(0, TOTAL_DEBT - computedAmount))}</span>
                </div>
                <div className="mt-3">
                  <Progress value={progress} />
                </div>
              </div>

              <button
                className="w-full rounded-2xl bg-blue-600 text-white py-3.5 text-base font-semibold shadow-lg active:translate-y-[1px]"
                onClick={() => {
                  alert(
                    `Payment scheduled: ${usd(computedAmount)}\nWhen: ${schedule}\nFrom: Checking ••••8241` +
                      (note ? `\nMemo: ${note}` : "")
                  );
                }}
              >
                Confirm payment
              </button>

              <div className="text-[11px] text-slate-500 text-center">This is a demo UI for testing only.</div>
            </section>
          )}

          {tab === "activity" && (
            <section className="mt-5">
              <SectionTitle>Recent activity</SectionTitle>

              {/* Group by date */}
              <div className="mt-2 space-y-4">
                {Object.entries(
                  txns.reduce((acc, t) => {
                    const key = t.date.toLocaleDateString(undefined, {
                      month: "short",
                      day: "numeric",
                      year: "numeric",
                    });
                    (acc[key] ||= []).push(t);
                    return acc;
                  }, {})
                ).map(([dateLabel, items]) => (
                  <div key={dateLabel}>
                    <div className="text-xs text-slate-500 mb-2">{dateLabel}</div>
                    <div className="rounded-2xl border border-slate-200 divide-y">
                      {items.map((t) => (
                        <div key={t.id} className="flex items-center gap-3 p-3">
                          {catIcon(t.category)}
                          <div className="flex-1 min-w-0">
                            <div className="text-sm font-medium truncate">{t.merchant}</div>
                            <div className="text-xs text-slate-500">{t.category}</div>
                          </div>
                          <div className="text-sm font-semibold">-{usd(t.amount)}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </section>
          )}

          {tab === "account" && (
            <section className="mt-5 space-y-4">
              <div className="rounded-2xl border border-slate-200 p-4">
                <div className="text-sm font-semibold">Card details</div>
                <div className="mt-2 text-sm text-slate-600">Visa •••• 3941</div>
                <div className="text-xs text-slate-500 mt-1">Member since 2018</div>
              </div>

              <div className="rounded-2xl border border-slate-200 p-4">
                <div className="text-sm font-semibold">Alerts & Controls</div>
                <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                  <button className="rounded-xl border border-slate-200 px-3 py-2 hover:bg-slate-50">Spending alert</button>
                  <button className="rounded-xl border border-slate-200 px-3 py-2 hover:bg-slate-50">Travel notice</button>
                  <button className="rounded-xl border border-slate-200 px-3 py-2 hover:bg-slate-50">Replace card</button>
                  <button className="rounded-xl border border-slate-200 px-3 py-2 hover:bg-slate-50">Statements</button>
                </div>
              </div>
            </section>
          )}
        </main>

        {/* Bottom Nav */}
        <nav className="fixed bottom-0 left-0 right-0 z-10 border-t border-slate-200 bg-white/95 backdrop-blur">
          <div className="mx-auto max-w-sm px-6 py-2 grid grid-cols-4 text-center text-xs">
            {[{k:"home",l:"Home"},{k:"pay",l:"Pay"},{k:"activity",l:"Activity"},{k:"account",l:"Account"}].map((item)=> (
              <button
                key={item.k}
                onClick={() => setTab(item.k === "home" ? "pay" : item.k)}
                className={`py-2 rounded-xl ${
                  (item.k === "home" && tab === "pay") || tab === item.k
                    ? "text-blue-600 font-semibold"
                    : "text-slate-500"
                }`}
              >
                {item.l}
              </button>
            ))}
          </div>
        </nav>
      </div>
    </div>
  );
}
